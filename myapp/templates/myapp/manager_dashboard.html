{% extends 'myapp/base.html' %}
{% load static %}

{% block title %}ACME Manufacturing Corp. - Manager Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'myapp/manager_dashboard.css' %}" />
{% endblock %}

{% block content %}

{% comment %} Inline style for the modal dialogs used in the dashboard (for additional context) {% endcomment %}
<style>
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0, 0, 0, 0.5);
  }

  .modal-content {
    background-color: white;
    margin: 10% auto;
    padding: 2rem;
    border-radius: 12px;
    width: 60%;
    position: relative;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  }

  .close-btn {
    position: absolute;
    top: 1rem;
    right: 1.5rem;
    font-size: 1.5rem;
    font-weight: bold;
    cursor: pointer;
  }
</style>

<nav class="navbar">
  <h1>ACME Manufacturing Manager Panel</h1>
</nav>

<main class="container">
  <h2>Welcome, Manager!</h2>

  {% comment %} Dynamic Summary Cards: Provide quick statistics such as the count of active, warning and faulty machines {% endcomment %}
  <div class="status-cards">
    <div class="card green">
      <h3>Active Machines</h3>
      <p>{{ active_machines }}</p>
    </div>
    <div class="card yellow">
      <h3>Machines Needing Attention</h3>
      <p>{{ warning_machines }}</p>
    </div>
    <div class="card red">
      <h3>Faulty Machines</h3>
      <p>{{ faulty_machines }}</p>
    </div>
  </div>

  {% comment %} Section: Manage Machinery, provides a form for managers to add new machines {% endcomment %}
  <section class="table-section">
    <h3>Manage Machinery</h3>
    <form method="post" action="{% url 'myapp:add_machine' %}" class="add-machine-form" enctype="multipart/form-data">
      {% csrf_token %}
      <input type="text" name="name" placeholder="Machine Name" required />
      <label for="collections">Select Existing Collection(s):</label>
      <select name="collections" id="collections" multiple>
        {% for collection in collections %}
          <option value="{{ collection.pk }}">{{ collection.name }}</option>
        {% endfor %}
      </select>
      <p>Or create new collection(s) (comma separated, e.g. Main-Campus, Building-A):</p>
      <input type="text" name="new_collections" placeholder="New Collection Names" />
      <br>
      <label for="machine-image">Machine Image (optional):</label>
      <input type="file" name="image" id="machine-image" accept="image/*" />
      <br>
      <button type="submit">Add Machine</button>
    </form>
  </section>

  {% comment %} Section: Export Report, provides a way for the manager to export a (CSV) based report on current machine filter {% endcomment %}
  <section class="table-section">
    <h3>Export Report</h3>
    <button>
      <a href="{% url 'myapp:export_report' %}?collection_filter={{ request.GET.collection_filter }}" style="text-decoration: none; color: inherit;">
        Export Report 
      </a> 
    </button>
  </section>

  {% comment %} Section: REST API, provides a way for testing external API submission to record a warning and fault cases {% endcomment %}
  <section class="table-section">
    <h3>Test External API Submission</h3>
    <form id="api_form" onsubmit="postWarning(event)">
      <label for="machine-id">Machine ID:</label>
      <input type="text" id="machine-id" required />
      <label for="warning-text">Warning:</label>
      <input type="text" id="warning-text" required />
      <button type="submit">Send Warning</button>
    </form>
  </section>

  <script>
    // Function to handle the warning submission
    function postWarning(e) {
      e.preventDefault();
      const machineId = document.getElementById("machine-id").value;
      const warningText = document.getElementById("warning-text").value;

      // Prepare the data to be sent to the backend
      const data = {
        machine_id: machineId,
        warning_text: warningText
      };

      // Send the data via a POST request using Fetch API
      fetch("/api/record_warning_fault/", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(data => {
        if (data.message) {
          alert(data.message); // Show success message
        } else {
          alert('Failed to submit warning or fault!');
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert('Error occurred during submission.');
      });
    }
  </script>

</main>

{% endblock %}
